!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.ActionCable={})}(this,function(t){"use strict";function s(t){if("function"==typeof t&&(t=t()),!t||/^wss?:/i.test(t))return t;var e=document.createElement("a");return e.href=t,e.href=e.href,e.protocol=e.protocol.replace("http","ws"),e.href}function e(t){var e=0<arguments.length&&t!==undefined?arguments[0]:n("url")||o.default_mount_path;return new i(e)}function n(t){var e=document.head.querySelector("meta[name='action-cable-"+t+"']");if(e)return e.getAttribute("content")}var f={logger:self.console,WebSocket:self.WebSocket},g={log:function r(){if(this.enabled){for(var t,e=arguments.length,n=Array(e),o=0;o<e;o++)n[o]=arguments[o];n.push(Date.now()),(t=f.logger).log.apply(t,["[ActionCable]"].concat(n))}}},h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},b=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},m=function(){function o(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}}(),v=function v(){return(new Date).getTime()},S=function S(t){return(v()-t)/1e3},d=function(){function e(t){b(this,e),this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=t,this.reconnectAttempts=0}return e.prototype.start=function t(){this.isRunning()||(this.startedAt=v(),delete this.stoppedAt,this.startPolling(),addEventListener("visibilitychange",this.visibilityDidChange),g.log("ConnectionMonitor started. stale threshold = "+this.constructor.staleThreshold+" s"))},e.prototype.stop=function n(){this.isRunning()&&(this.stoppedAt=v(),this.stopPolling(),removeEventListener("visibilitychange",this.visibilityDidChange),g.log("ConnectionMonitor stopped"))},e.prototype.isRunning=function o(){return this.startedAt&&!this.stoppedAt},e.prototype.recordPing=function i(){this.pingedAt=v()},e.prototype.recordConnect=function r(){this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,g.log("ConnectionMonitor recorded connect")},e.prototype.recordDisconnect=function s(){this.disconnectedAt=v(),g.log("ConnectionMonitor recorded disconnect")},e.prototype.startPolling=function c(){this.stopPolling(),this.poll()},e.prototype.stopPolling=function u(){clearTimeout(this.pollTimeout)},e.prototype.poll=function p(){var t=this;this.pollTimeout=setTimeout(function(){t.reconnectIfStale(),t.poll()},this.getPollInterval())},e.prototype.getPollInterval=function l(){var t=this.constructor,e=t.staleThreshold,n=t.reconnectionBackoffRate;return 1e3*e*Math.pow(1+n,Math.min(this.reconnectAttempts,10))*(1+(0===this.reconnectAttempts?1:n)*Math.random())},e.prototype.reconnectIfStale=function h(){this.connectionIsStale()&&(g.log("ConnectionMonitor detected stale connection. reconnectAttempts = "+this.reconnectAttempts+", time stale = "+S(this.refreshedAt)+" s, stale threshold = "+this.constructor.staleThreshold+" s"),this.reconnectAttempts++,this.disconnectedRecently()?g.log("ConnectionMonitor skipping reopening recent disconnect. time disconnected = "+S(this.disconnectedAt)+" s"):(g.log("ConnectionMonitor reopening"),this.connection.reopen()))},e.prototype.connectionIsStale=function a(){return S(this.refreshedAt)>this.constructor.staleThreshold},e.prototype.disconnectedRecently=function f(){return this.disconnectedAt&&S(this.disconnectedAt)<this.constructor.staleThreshold},e.prototype.visibilityDidChange=function d(){var t=this;"visible"===document.visibilityState&&setTimeout(function(){!t.connectionIsStale()&&t.connection.isOpen()||(g.log("ConnectionMonitor reopening stale connection on visibilitychange. visibilityState = "+document.visibilityState),t.connection.reopen())},200)},m(e,[{key:"refreshedAt",get:function y(){return this.pingedAt?this.pingedAt:this.startedAt}}]),e}();d.staleThreshold=6,d.reconnectionBackoffRate=.15;var o={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},disconnect_reasons:{unauthorized:"unauthorized",invalid_request:"invalid_request",server_restart:"server_restart"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]},c=o.message_types,y=o.protocols,A=y.slice(0,y.length-1),w=[].indexOf,u=function(){function e(t){b(this,e),this.open=this.open.bind(this),this.consumer=t,this.subscriptions=this.consumer.subscriptions,this.monitor=new d(this),this.disconnected=!0}return e.prototype.send=function n(t){return!!this.isOpen()&&(this.webSocket.send(JSON.stringify(t)),!0)},e.prototype.open=function t(){return this.isActive()?(g.log("Attempted to open WebSocket, but existing socket is "+this.getState()),!1):(g.log("Opening WebSocket, current state is "+this.getState()+", subprotocols: "+y),this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new f.WebSocket(this.consumer.url,y),this.installEventHandlers(),this.monitor.start(),!0)},e.prototype.close=function o(t){if((0<arguments.length&&t!==undefined?arguments[0]:{allowReconnect:!0}).allowReconnect||this.monitor.stop(),this.isActive())return this.webSocket.close()},e.prototype.reopen=function i(){if(g.log("Reopening WebSocket, current state is "+this.getState()),!this.isActive())return this.open();try{return this.close()}catch(t){g.log("Failed to reopen WebSocket",t)}finally{g.log("Reopening WebSocket in "+this.constructor.reopenDelay+"ms"),setTimeout(this.open,this.constructor.reopenDelay)}},e.prototype.getProtocol=function r(){if(this.webSocket)return this.webSocket.protocol},e.prototype.isOpen=function s(){return this.isState("open")},e.prototype.isActive=function c(){return this.isState("open","connecting")},e.prototype.isProtocolSupported=function u(){return 0<=w.call(A,this.getProtocol())},e.prototype.isState=function p(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];return 0<=w.call(e,this.getState())},e.prototype.getState=function l(){if(this.webSocket)for(var t in f.WebSocket)if(f.WebSocket[t]===this.webSocket.readyState)return t.toLowerCase();return null},e.prototype.installEventHandlers=function h(){for(var t in this.events){var e=this.events[t].bind(this);this.webSocket["on"+t]=e}},e.prototype.uninstallEventHandlers=function a(){for(var t in this.events)this.webSocket["on"+t]=function(){}},e}();u.reopenDelay=500,u.prototype.events={message:function t(e){if(this.isProtocolSupported()){var n=JSON.parse(e.data),o=n.identifier,t=n.message,i=n.reason,r=n.reconnect;switch(n.type){case c.welcome:return this.monitor.recordConnect(),this.subscriptions.reload();case c.disconnect:return g.log("Disconnecting. Reason: "+i),this.close({allowReconnect:r});case c.ping:return this.monitor.recordPing();case c.confirmation:return this.subscriptions.notify(o,"connected");case c.rejection:return this.subscriptions.reject(o);default:return this.subscriptions.notify(o,"received",t)}}},open:function C(){if(g.log("WebSocket onopen event, using '"+this.getProtocol()+"' subprotocol"),this.disconnected=!1,!this.isProtocolSupported())return g.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close:function k(){if(g.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error:function P(){g.log("WebSocket onerror event")}};var p=function p(t,e){if(null!=e)for(var n in e){var o=e[n];t[n]=o}return t},a=function(){function r(t,e,n){var o=1<arguments.length&&e!==undefined?arguments[1]:{},i=n;b(this,r),this.consumer=t,this.identifier=JSON.stringify(o),p(this,i)}return r.prototype.perform=function o(t,e){var n=1<arguments.length&&e!==undefined?arguments[1]:{};return n.action=t,this.send(n)},r.prototype.send=function e(t){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(t)})},r.prototype.unsubscribe=function t(){return this.consumer.subscriptions.remove(this)},r}(),l=function(){function e(t){b(this,e),this.consumer=t,this.subscriptions=[]}return e.prototype.create=function r(t,e){var n=t,o="object"===(void 0===n?"undefined":h(n))?n:{channel:n},i=new a(this.consumer,o,e);return this.add(i)},e.prototype.add=function n(t){return this.subscriptions.push(t),this.consumer.ensureActiveConnection(),this.notify(t,"initialized"),this.sendCommand(t,"subscribe"),t},e.prototype.remove=function o(t){return this.forget(t),this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe"),t},e.prototype.reject=function i(t){var e=this;return this.findAll(t).map(function(t){return e.forget(t),e.notify(t,"rejected"),t})},e.prototype.forget=function t(e){return this.subscriptions=this.subscriptions.filter(function(t){return t!==e}),e},e.prototype.findAll=function s(e){return this.subscriptions.filter(function(t){return t.identifier===e})},e.prototype.reload=function c(){var e=this;return this.subscriptions.map(function(t){return e.sendCommand(t,"subscribe")})},e.prototype.notifyAll=function u(e){for(var n=this,t=arguments.length,o=Array(1<t?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];return this.subscriptions.map(function(t){return n.notify.apply(n,[t,e].concat(o))})},e.prototype.notify=function p(t,e){for(var n=arguments.length,o=Array(2<n?n-2:0),i=2;i<n;i++)o[i-2]=arguments[i];return("string"==typeof t?this.findAll(t):[t]).map(function(t){return"function"==typeof t[e]?t[e].apply(t,o):undefined})},e.prototype.sendCommand=function l(t,e){var n=t.identifier;return this.consumer.send({command:e,identifier:n})},e}(),i=function(){function e(t){b(this,e),this._url=t,this.subscriptions=new l(this),this.connection=new u(this)}return e.prototype.send=function n(t){return this.connection.send(t)},e.prototype.connect=function t(){return this.connection.open()},e.prototype.disconnect=function o(){return this.connection.close({allowReconnect:!1})},e.prototype.ensureActiveConnection=function i(){if(!this.connection.isActive())return this.connection.open()},m(e,[{key:"url",get:function r(){return s(this._url)}}]),e}();t.Connection=u,t.ConnectionMonitor=d,t.Consumer=i,t.INTERNAL=o,t.Subscription=a,t.Subscriptions=l,t.adapters=f,t.createWebSocketURL=s,t.logger=g,t.createConsumer=e,t.getConfig=n,Object.defineProperty(t,"__esModule",{value:!0})}),function(){this.App||(this.App={}),App.cable=ActionCable.createConsumer()}.call(this);